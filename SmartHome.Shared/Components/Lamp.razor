@using SmartHome.Dto.Command
@using SmartHome.Dto.Dashboard
@using SmartHome.Shared.Interfaces
@using SmartHome.Shared.Models
@inject IApiService ApiService

<!-- Lamp Card -->

<div class="bg-[#FFFDEB] rounded-xl p-2 flex flex-col items-center gap-2 shadow-sm" style="@(!isPowerOn ? "background-color:#FFFFFF;" : "background-color:#FFFDEB;") cursor: pointer;" @onclick="ToggleDevicePower">
    @if (DeviceModel.State.ContainsKey("power_state"))
    {
        <div class="flex align-items-center justify-content-between w-100">
            @if (!isPowerOn)
            {
                <div>
                    <img src="_content/SmartHome.Shared/imgs/Lamp_Off.svg" alt="Lamp On" class="w-12 h-12 object-contain">

                </div>
                <div>Turn On<i class="bi bi-power"></i></div>
            }
            else
            {
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="42" height="50" viewBox="0 0 42 50">
                        <image xlink:href="data:image/png;base64,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" x="0" y="0" width="42" height="50" />
                    </svg>
                </div>
                <div>Turn Off<i class="bi bi-power"></i></div>
            }
        </div>

        <div class="flex align-items-center justify-content-between w-100">
            <div><h3 class="text-gray-600 font-normal">@DeviceModel.Name</h3></div>
            @if (!isPowerOn)
            {
                <div><img src="_content/SmartHome.Shared/imgs/CircleOff.png" alt="StatusOff" class="w-4 h-4" /></div>
            }
            else
            {
                <div><img src="_content/SmartHome.Shared/imgs/CircleOnLamp.png" alt="StatusOn" class="w-4 h-4" /></div>
            }

        </div>
    }
    else
    {
        <div>Device is Malfunctioning</div>
    }
</div>

@code {
    [Parameter]
    public OverviewDeviceDto DeviceModel { get; set; } = new();

    [Parameter]
    public Guid ControllerId { get; set; }

    private bool isPowerOn = false; // Default state is off

    protected override void OnParametersSet() // Use OnParametersSet to react to parameter changes
    {
        base.OnParametersSet();
        Console.WriteLine($"LampCard: OnParametersSet called for Device: {DeviceModel.Name}, DeviceId: {DeviceModel.Id}"); // Debug print
        UpdateVisualState(); // Call UpdateVisualState when parameters are set or updated
    }

    private void UpdateVisualState()
    {
        if (DeviceModel.State.TryGetValue("power_state", out var powerStateValue))
        {
            isPowerOn = powerStateValue?.ToString()?.ToLower() == "on";
        }
        else
        {
            isPowerOn = false;
        }
        StateHasChanged(); // Ensure UI updates after state change
    }


    private async Task ToggleDevicePower()
    {
        if (!DeviceModel.State.ContainsKey("power_state"))
        {
            Console.WriteLine("Device state does not contain 'power_state'. Cannot toggle.");
            return; // Or handle error appropriately
        }

        bool turnOn = !isPowerOn; // Toggle to the opposite of the *current visual state*

        var commandRequest = new CommandRequestDto()
            {
                AreaId = DeviceModel.AreaId,
                ControllerId = ControllerId,
                Devices = new List<DeviceCommandDto>()
            {
                new DeviceCommandDto()
                {
                    DeviceId = DeviceModel.Id,
                    Function = "toggle",
                    Parameters = new Dictionary<string, object>()
                    {
                        { "state", turnOn }
                    }
                }
            }
            };

        try
        {
            // Assuming you have a CommandResponseDto defined to handle the response from the command endpoint
            var commandResponse = await ApiService.PostAsync<CommandResponseDto, CommandRequestDto>("/api/command/send-command", commandRequest);

            if (commandResponse != null && commandResponse.Status?.ToLower() == "success")
            {
                // Command was successful. Update the UI to reflect the new state.

                if (DeviceModel.State.ContainsKey("power_state"))
                {
                    DeviceModel.State["power_state"] = turnOn ? "on" : "off";
                }
                UpdateVisualState(); // Update visual state based on the new DeviceModel.State
                StateHasChanged(); // Re-render the component to reflect the state change
            }
            else
            {
                // Command failed. Handle error (e.g., display error message to user)
                Console.WriteLine($"Command failed: {commandResponse?.Devices[0].Message ?? "Unknown error"}");
                // Optionally, show an error message to the user.
            }
        }
        catch (Exception ex)
        {
            // Exception during API call. Handle error.
            Console.WriteLine($"Exception during command: {ex.Message}");
            // Optionally, show an error message to the user.
        }
    }
}