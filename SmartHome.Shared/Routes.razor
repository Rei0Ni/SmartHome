@using SmartHome.Shared.Pages
@using SmartHome.Shared.Pages.Mobile_Specific
@using SmartHome.Shared.Services

<CascadingAuthenticationState>
    <ErrorBoundary>
        <Router AppAssembly="typeof(AuthLayout).Assembly">
            <Found Context="routeData">
                @if (HostStatusService.HasHostConfigurationError)
                {
                    navigationManager.NavigateTo("/hostconfigerror");
                }
                @if (HostStatusService.HasNoNetworkConnectionError){
                    navigationManager.NavigateTo("/connectionerror");
                }
                @if (routeData.PageType == typeof(Pages.Entry))
                { 
                    <RouteView RouteData="@routeData" DefaultLayout="typeof(AuthLayout)" />
                }
                else
                {
                    <AuthorizeRouteView RouteData="@routeData" DefaultLayout="typeof(AuthLayout)">
                        <Authorizing>
                            <div class="flex flex-col justify-center items-center h-full">
                                <img src="_content/SmartHome.Shared/imgs/Loading_Lamp.svg" />

                                <div class="mt-3 flex justify-center">
                                    <span class="text-2xl font-semibold dark:text-gray-50">Smart Home</span>
                                </div>
                            </div>
                        </Authorizing>
                    </AuthorizeRouteView>
                }
            </Found>
            <NotFound>
                <PageTitle>Not found</PageTitle>
                <CascadingAuthenticationState>
                    <LayoutView Layout="@typeof(MainLayout)">
                        <div class="d-flex justify-content-center align-items-center" style="height:70vh">
                            <div class="align-items-center">
                                <div class="d-flex justify-content-center">
                                    <span style="font-size:50px">&#128577;</span>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <b style="font-size:50px">404</b>
                                </div>
                                <div class="d-flex justify-content-center">
                                    <span class="fw-bold fs-3">Oops I think this page doesn't exist</span>
                                </div>
                            </div>
                        </div>
                    </LayoutView>
                </CascadingAuthenticationState>
            </NotFound>
        </Router>
    </ErrorBoundary>
</CascadingAuthenticationState>

@code {

    protected override async Task OnInitializedAsync()
    {
        await SettingsService.LoadSettingsAsync();
        refreshService.OnRefreshRequested += HandleRefreshRequested;
        await base.OnInitializedAsync();
    }

    private void HandleRefreshRequested()
    {
        // Reload the page using NavigationManager.
        navigationManager.NavigateTo(navigationManager.Uri, forceLoad: true);
    }

    public void Dispose()
    {
        // Unsubscribe to avoid memory leaks.
        refreshService.OnRefreshRequested += HandleRefreshRequested;
    }
}